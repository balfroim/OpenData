{% extends 'base.html' %}

{% load static question %}

{% block title %}Question - {{ question.content.text }}{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/questions.css' %}">
{% endblock %}

{% block main %}
  <p class="breadcrumbs">
    <a href="{% url 'home' %}">
      Accueil
      <i class="fas fa-home"></i>
    </a>
    {% if question.dataset %}
      {% with dataset=question.dataset %}
        <a href="{% url 'theme' theme_id=dataset.theme.id %}">
          {{ dataset.theme.name }}
        </a>
        <a href="{% url 'dataset' dataset_id=dataset.id %}">
          {{ dataset.title }}
        </a>
      {% endwith %}
    {% endif %}
    <a href="{% url 'question' question_id=question.id %}">
      "{{ question.content.text }}"
    </a>
  </p>

  {% question_card question user false %}

  <div id="answers">
    {% answers_of question %}
  </div>

  {% if user.profile.is_registered %}
    <h2>RÃ©pondre</h2>
    <form id="reply-form">
      {% csrf_token %}
      <textarea name="content" id="answer_content"></textarea>
      <input type="url" name="source" id="answer_source"  placeholder="Ajoutez une source">
      <button><i class="fas fa-reply"></i></button>
    </form>
  {% endif %}

  <script>
    const answerForm = document.querySelector('#reply-form')
    const answersDiv = document.querySelector('#answers')

    answerForm.addEventListener('submit', async event => {
      event.preventDefault()

      const response = await fetch("{% url "add-answer" question.id %}", {
        method: 'POST',
        body: new URLSearchParams(new FormData(answerForm)),
        headers: new Headers({'X-CSRFToken': '{{ csrf_token }}'}),
      })

      if (response.ok) {
        answersDiv.innerHTML = await response.text();
        answerForm.querySelector('#answer_content').value = ''
      }
    })
  </script>
{% endblock %}
